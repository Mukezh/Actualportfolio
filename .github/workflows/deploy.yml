name: Portfolio

on:
    push:
        branches:
            - master

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: checkout repo
              uses: actions/checkout@v3
            
            - name: decode ssh
              run: |
                echo "${{ secrets.AWS_SSH_KEY }}" | base64 -d > awskey.pem
                chmod 600 awskey.pem
            
            - name: copy files to aws via ssh
              uses: appleboy/scp-action@v0.1.4
              with:
                host: ${{ secrets.AWS_HOST }}
                username: ${{ secrets.AWS_USER }}
                key: awskey.pem
                source: "."
                target: "/home/ubuntu/portfolio"
            
            - name: ssh into server and restart service
              uses: appleboy/ssh-action@master
              with:
                host: ${{ secrets.AWS_HOST }}
                username: ${{ secrets.AWS_USER }}
                key: awskey.pem
                script: |
                    cd /home/ubuntu/portfolio
                    git pull origin master
                    npm install
                    npm run build
                    sudo cp -r dist/* /var/www/html/
